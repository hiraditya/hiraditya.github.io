<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Opportunities of performance improvements in the C++ Standard Library -</title>
<meta name="description" content="Introduction to the C++ Standard Library ">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="">
<meta property="og:title" content="Opportunities of performance improvements in the C++ Standard Library">
<meta property="og:url" content="http://localhost:4000/performance/performance-analysis-of-c++-standard-library/">


  <meta property="og:description" content="Introduction to the C++ Standard Library ">







  <meta property="article:published_time" content="2020-04-25T19:11:59-07:00">





  

  


<link rel="canonical" href="http://localhost:4000/performance/performance-analysis-of-c++-standard-library/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Aditya K",
      "url": "http://localhost:4000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title=" Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/">Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/Resume">About Me</a>
            </li><li class="masthead__menu-item">
              <a href="/Talks">Talks</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name"></h3>
    
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Opportunities of performance improvements in the C++ Standard Library">
    <meta itemprop="description" content="Introduction to the C++ Standard Library">
    <meta itemprop="datePublished" content="2020-04-25T19:11:59-07:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Opportunities of performance improvements in the C++ Standard Library
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  2 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-cog"></i> Table of Contents</h4></header>
              <ul class="toc__menu">
  <li><a href="#introduction-to-the-c-standard-library">Introduction to the C++ Standard Library</a>
    <ul>
      <li><a href="#performance-opportunities-in-the-c-standard-library">Performance opportunities in the C++ standard library</a></li>
      <li><a href="#standard-library-containers">Standard Library Containers</a>
        <ul>
          <li><a href="#stl">STL:</a></li>
        </ul>
      </li>
      <li><a href="#standard-library-algorithms">Standard library algorithms</a></li>
      <li><a href="#source-code-annotations-to-improve-performance">Source code annotations to improve performance</a>
        <ul>
          <li><a href="#annotating-non-returning-functions">Annotating non-returning functions:</a></li>
        </ul>
      </li>
      <li><a href="#compiler-optimizations-that-can-help-improve-the-performance-of-c-standard-library">Compiler optimizations that can help improve the performance of C++ standard library:</a>
        <ul>
          <li><a href="#whole-program-devirtualization">Whole program devirtualization</a></li>
          <li><a href="#inlining-important-functions">Inlining important functions:</a></li>
          <li><a href="#vectorization">Vectorization</a></li>
          <li><a href="#loop-idiom-recognition">Loop idiom recognition</a></li>
          <li><a href="#jump-threading">Jump Threading</a></li>
          <li><a href="#profile-guided-optimization-of-c-standard-library-auto-fdo">Profile guided optimization of C++ standard library (Auto-FDO)</a></li>
          <li><a href="#loop-unrolling">Loop unrolling</a></li>
        </ul>
      </li>
      <li><a href="#miscellaneous">Miscellaneous:</a></li>
    </ul>
  </li>
</ul>

            </nav>
          </aside>
        
        <h2 id="introduction-to-the-c-standard-library">Introduction to the C++ Standard Library</h2>

<p>The C++ standard library is a collection of classes and functions. These are written in C++ and are part of the C++ standard itself. All popular compiler toolchains come with a C++ standard library. The popular ones are <em>libstdc++ (GNU)</em>, <em>libc++(LLVM)</em> also popularly known as <em>libcxx</em>, <em>msvc-stl</em>(appears to be derived from <em>dinkumware C++ library</em> and <em>libc++</em> and was upstreamed in 2019). Needless to say, the standard library plays a very important role in the runtime performance of many systems.</p>

<p>Over a period of time I have collected a list of performance opportunities. Some of them I found online from the mailing list and bugzilla. Others by reading source code, and previous experience with the performance analysis of <em>libstdc++</em> and <em>libc++</em>. Disclaimer: For some of the items below I do not have experimental numbers, and I’m mostly relying on what was reported in the references.</p>

<h3 id="performance-opportunities-in-the-c-standard-library">Performance opportunities in the C++ standard library</h3>

<p>The algorithmic requirements on STL and their compliance by all the popular libraries makes it easy to believe that the performance couldn’t be improved further. The requirements are based on computational complexity theory <a href="https://en.wikipedia.org/wiki/Big_O_notation">big O and friends</a>. Because the constant factor isn’t taken into account (for good reasons), the realized performance depends on the actual implementation and the workload. The <code class="highlighter-rouge">iostream</code> library is just slow, like almost all the interfaces are slow (probably except for the ones I optimized ;) ). The source code looks very much like a typical Java program (too many indirections and virtual methods).</p>

<p>There are four subsections to classify performance opportunities.</p>
<ul>
  <li>Standard Library Containers
    <ul>
      <li>like STL Containers, <code class="highlighter-rouge">iostream</code> library</li>
    </ul>
  </li>
  <li>Standard Library Algorithms
    <ul>
      <li><code class="highlighter-rouge">sort</code>, <code class="highlighter-rouge">find</code></li>
    </ul>
  </li>
  <li>Source code annotations to improve performance
    <ul>
      <li>to help compiler make better optimization decisions</li>
    </ul>
  </li>
</ul>

<h3 id="standard-library-containers">Standard Library Containers</h3>
<h4 id="stl">STL:</h4>
<p><strong>std::vector</strong></p>
<ul>
  <li>Allocator in <code class="highlighter-rouge">std::vector</code> has perf issues (See: <a href="https://bugs.llvm.org/show_bug.cgi?id=35637">Really bad codegen for libc++ vector</a>). Use realloc whenever appropriate. Some improvements were proposed in (See: [Improving std::vector<char> and std::deque<char> perfomance][10].</char></char></li>
</ul>

<p><strong>std::string</strong></p>
<ul>
  <li><code class="highlighter-rouge">string::find.*of</code>, and <code class="highlighter-rouge">string::rfind</code> are still suboptimal (See <a href="https://gcc.gnu.org/bugzilla/show_bug.cgi?id=93584">string</a>)</li>
</ul>

<p><strong>std::map</strong></p>
<ul>
  <li>This is in general slow because of pointer chasing. There might be other issues with the implementation of rb-tree. Needs more investigation.</li>
</ul>

<p><strong>std::iostream</strong></p>
<ul>
  <li>Istream is very slow (<a href="https://github.com/hiraditya/std-benchmark/blob/master/docs/slides/slide-cppnow.pdf">istream</a>)</li>
  <li><code class="highlighter-rouge">std::ostream</code> is very slow (<a href="https://bugs.llvm.org/show_bug.cgi?id=40763">ostream</a>)</li>
</ul>

<h3 id="standard-library-algorithms">Standard library algorithms</h3>

<ul>
  <li><code class="highlighter-rouge">std::sort</code>: of clang/gcc may be slow depending on the workload (<a href="https://gcc.gnu.org/bugzilla/show_bug.cgi?id=82739">sort</a>).</li>
  <li><code class="highlighter-rouge">std::find</code> of <em>libcxx</em> is very slow compared to <em>libstdc++</em> because llvm does not unroll the loop automatically (<a href="https://bugs.llvm.org/show_bug.cgi?id=19708">find</a>).</li>
</ul>

<h3 id="source-code-annotations-to-improve-performance">Source code annotations to improve performance</h3>
<h4 id="annotating-non-returning-functions">Annotating non-returning functions:</h4>
<p>This will help the compiler reorganize basic blocks in the function.</p>

<p>Annotating pointers with restrict:</p>
<ul>
  <li>Adding restrict will help alias analysis and many other PRE type optimizations.</li>
</ul>

<p>Annotating branches with <code class="highlighter-rouge">builtin_likely</code>:</p>
<ul>
  <li>This will help basic block reordering and hence help locality. In some cases it can save a branch.</li>
</ul>

<h3 id="compiler-optimizations-that-can-help-improve-the-performance-of-c-standard-library">Compiler optimizations that can help improve the performance of C++ standard library:</h3>
<h4 id="whole-program-devirtualization">Whole program devirtualization</h4>
<p>Devirtualization will help the iostream library because it has too many virtual methods.</p>

<h4 id="inlining-important-functions">Inlining important functions:</h4>
<p>Constructors and destructors of STL containers like <code class="highlighter-rouge">string</code>, <code class="highlighter-rouge">vector</code> etc.</p>

<h4 id="vectorization">Vectorization</h4>
<p>Vectorize <code class="highlighter-rouge">memcpy</code>, <code class="highlighter-rouge">memset</code> etc style loops. Also related to Loop Idiom Recognition</p>

<h4 id="loop-idiom-recognition">Loop idiom recognition</h4>
<p>Detect <code class="highlighter-rouge">memcpy</code>, <code class="highlighter-rouge">memset</code>, <code class="highlighter-rouge">memchr</code>, <code class="highlighter-rouge">memcmp</code> style loops</p>

<h4 id="jump-threading">Jump Threading</h4>
<p>Even better, jump threading with auto-FDO. (See: <a href="https://bugs.llvm.org/show_bug.cgi?id=43276">Jump Threading Bug</a>)</p>

<h4 id="profile-guided-optimization-of-c-standard-library-auto-fdo">Profile guided optimization of C++ standard library (Auto-FDO)</h4>
<p>Helps bring micro-optimization and code-layout tuned according to our workloads</p>

<h4 id="loop-unrolling">Loop unrolling</h4>

<p><code class="highlighter-rouge">std::find</code> will benefit from:
    - Loop unrolling (See <a href="https://bugs.llvm.org/show_bug.cgi?id=19708">Loop unroll opportunities</a>)
    - Needs loop rotation to make loop-unroll more effective (See: <a href="https://bugs.llvm.org/show_bug.cgi?id=27360">Loop rotation bug</a>)</p>

<h3 id="miscellaneous">Miscellaneous:</h3>
<p>CoroFrame does not pay attention to the lifetime markers (See <a href="https://bugs.llvm.org/show_bug.cgi?id=41877">CoroFrame</a>)</p>


        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#c-standard-library" class="page__taxonomy-item" rel="tag">C++ Standard Library</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#performance" class="page__taxonomy-item" rel="tag">Performance</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#performance" class="page__taxonomy-item" rel="tag">Performance</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2020-04-25T19:11:59-07:00">April 25, 2020</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Opportunities+of+performance+improvements+in+the+C%2B%2B+Standard+Library%20http%3A%2F%2Flocalhost%3A4000%2Fperformance%2Fperformance-analysis-of-c%2B%2B-standard-library%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fperformance%2Fperformance-analysis-of-c%2B%2B-standard-library%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fperformance%2Fperformance-analysis-of-c%2B%2B-standard-library%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/compiler/toolchain-description/" class="pagination--pager" title="Introduction to compiler toolchain!
">Previous</a>
    
    
      <a href="#" class="pagination--pager disabled">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You may also enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/compiler/toolchain-description/" rel="permalink">Introduction to compiler toolchain!
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  4 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">What is a compiler toolchain?
Have you ever wondered what dependencies are required to compile a simple hello-world program? Even a small hello-world program...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/_hiraditya_" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
      
        
          <li><a href="https://github.com/hiraditya" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2020 Aditya K. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>







    
  <script>
    var disqus_config = function () {
      this.page.url = "http://localhost:4000/performance/performance-analysis-of-c++-standard-library/";  /* Replace PAGE_URL with your page's canonical URL variable */
      this.page.identifier = "/performance/performance-analysis-of-c++-standard-library"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */
    };
    (function() { /* DON'T EDIT BELOW THIS LINE */
      var d = document, s = d.createElement('script');
      s.src = 'https://https://help.disqus.com/customer/portal/articles/466208-what-s-a-shortname-.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  





  </body>
</html>
